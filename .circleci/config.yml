version: 2.1

jobs:
  build:
    docker:
      - image: cimg/go:1.18
    working_directory: /home/circleci/project  # Use a more standard path for CircleCI

    steps:
      - checkout

      # Ensure /go directory exists and has correct permissions
      - run:
          name: Create directories with proper permissions
          command: |
            sudo mkdir -p /go/src/github.com/bcates277/invoicer-chapter2
            sudo chown -R circleci:circleci /go

      - setup_remote_docker

      - run:
          name: Setup environment
          command: |
            gb="/src/github.com/${THE_CIRCLE_PROJECT_USERNAME}";
            if [ ${THE_CIRCLE_PROJECT_USERNAME} == 'Securing-DevOps' ]; then
              dr="securingdevops"
            else
              dr=$DOCKER_USER
            fi
            cat >> $BASH_ENV \<<EOF
            export GOPATH_HEAD="$(echo ${GOPATH}|cut -d ':' -f 1)"
            export GOPATH_BASE="$(echo ${GOPATH}|cut -d ':' -f 1)${gb}"
            export DOCKER_REPO="$dr"
            EOF

      - run:
          name: Make directories
          command: |
            mkdir -p "${GOPATH_BASE}"
            mkdir -p "${GOPATH_HEAD}/bin"

      - run:
          name: Testing application
          command: |
            go test github.com/${THE_CIRCLE_PROJECT_USERNAME}/${THE_CIRCLE_PROJECT_REPONAME}

      - run:
          name: Build Go binary
          command: |
            go install --ldflags '-extldflags "-static"' \
            github.com/${THE_CIRCLE_PROJECT_USERNAME}/${THE_CIRCLE_PROJECT_REPONAME}
            mkdir -p bin
            cp "$GOPATH_HEAD/bin/${THE_CIRCLE_PROJECT_REPONAME}" bin/invoicer

      - run:
          name: Build Docker Image
          command: |
            docker build -t ${DOCKER_REPO}/${THE_CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1} .

      - run:
          name: Push Docker Image (only on master)
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
              docker push ${DOCKER_REPO}/${THE_CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1}
            fi

      # Install ZAP (OWASP Zed Attack Proxy)
      - run:
          name: Install ZAP
          command: |
            docker pull zaproxy/zap-stable

      # Run ZAP against the application in the Docker container
      - run:
          name: Run ZAP scan
          command: |
            docker run --rm \
              -v /home/circleci/project:/zap/wrk:rw \
              -p 8080:8080 \
              zaproxy/zap-stable zap-webswing.sh &

            # Run the Go application
            ./bin/invoicer

      - run:
          name: Check if ZAP is accessible
          command: |
            curl http://localhost:8080

workflows:
  version: 2
  release:
    jobs:
      - build
